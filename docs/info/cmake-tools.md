# CMake + CubeMX/CubeCLT Toolchain

## Installing

1. Install [CubeMX](https://www.st.com/en/development-tools/stm32cubemx.html#get-software). This is the `.ioc` file editor.
2. Install [CubeCLT](https://www.st.com/en/development-tools/stm32cubeclt.html#get-software).
   This is the command-line toolset that contains all the software necessary to build and deploy the codebase.
3. Install [CubeMCUFinder](https://www.st.com/en/development-tools/st-mcu-finder-pc.html#get-software).
4. Install the corresponding extension for your editor. In each case, the extension will need to be provided the location to CubeMX and CubeCLT.
    1. [CLion](https://www.jetbrains.com/help/clion/embedded-stm32.html)
    2. [VS Code](https://www.st.com/content/st_com/en/campaigns/stm32-vs-code-extension-z11.html)

## Creating a New CubeMX Project

1. Open CubeMX and navigate to `File`&#8594;`New Project`.
2. A window should pop up. In this window, select your desired MCU or development board.
   To search, use the "Commercial Part Number" search bar.
3. When you have selected your MCU/board, click `Start Project` in the top right.
4. Navigate to the `Project Manager` tab.
5. Give your project a name and set the `Project Location` to the desired directory.
6. Set the `Toolchain / IDE` dropdown to `CMake`.
7. Save the project by navigating to `File`&#8594;`Save Project` or by pressing `Ctrl + S`.
8. Click `Generate Code` in the top right. CubeMX will generate the project files in the specified directory.
   For example, if the project name is `myproject` and the location is `/home/user/mrover-esw/src/`,
   the generated files will be in `/home/user/mrover-esw/src/myproject/`.

## Adding CMake Dependencies to Projects

### Removing Dependency on Generated HAL Drivers

By default, CubeMX generates HAL drivers and includes them in the project. The top level
CMakeLists.txt then includes these generated HAL drivers in the build with the following
line:

```cmake
add_subdirectory(cmake/stm32cubemx)
```

If you take a look inside the CMakeLists.txt inside the `cmake/stm32cubemx/` directory,
you will see that it includes all of the generated HAL drivers for the selected MCU. This
CMakeLists.txt is automatically generated by CubeMX to include the necessary HAL drivers
your project requires. For example:

```cmake
set(STM32_Drivers_Src
    ${CMAKE_CURRENT_SOURCE_DIR}/../../Core/Src/system_stm32g4xx.c
    ${CMAKE_CURRENT_SOURCE_DIR}/../../Drivers/STM32G4xx_HAL_Driver/Src/stm32g4xx_hal_pwr_ex.c
    ${CMAKE_CURRENT_SOURCE_DIR}/../../Drivers/STM32G4xx_HAL_Driver/Src/stm32g4xx_hal.c
    ${CMAKE_CURRENT_SOURCE_DIR}/../../Drivers/STM32G4xx_HAL_Driver/Src/stm32g4xx_hal_rcc.c
    ${CMAKE_CURRENT_SOURCE_DIR}/../../Drivers/STM32G4xx_HAL_Driver/Src/stm32g4xx_hal_rcc_ex.c
    ${CMAKE_CURRENT_SOURCE_DIR}/../../Drivers/STM32G4xx_HAL_Driver/Src/stm32g4xx_hal_flash.c
    ${CMAKE_CURRENT_SOURCE_DIR}/../../Drivers/STM32G4xx_HAL_Driver/Src/stm32g4xx_hal_flash_ex.c
    ${CMAKE_CURRENT_SOURCE_DIR}/../../Drivers/STM32G4xx_HAL_Driver/Src/stm32g4xx_hal_flash_ramfunc.c
    ${CMAKE_CURRENT_SOURCE_DIR}/../../Drivers/STM32G4xx_HAL_Driver/Src/stm32g4xx_hal_gpio.c
    ${CMAKE_CURRENT_SOURCE_DIR}/../../Drivers/STM32G4xx_HAL_Driver/Src/stm32g4xx_hal_exti.c
    ${CMAKE_CURRENT_SOURCE_DIR}/../../Drivers/STM32G4xx_HAL_Driver/Src/stm32g4xx_hal_dma.c
    ${CMAKE_CURRENT_SOURCE_DIR}/../../Drivers/STM32G4xx_HAL_Driver/Src/stm32g4xx_hal_dma_ex.c
    ${CMAKE_CURRENT_SOURCE_DIR}/../../Drivers/STM32G4xx_HAL_Driver/Src/stm32g4xx_hal_pwr.c
    ${CMAKE_CURRENT_SOURCE_DIR}/../../Drivers/STM32G4xx_HAL_Driver/Src/stm32g4xx_hal_cortex.c
)
```

These generated HAL drivers total over 900 files, which is unnecessary and would bloat
the repository if committed. In order to prevent this, we remove the dependency on the
generated HAL drivers for each project and instead use a shared HAL driver library which
is hosted as a git submodule in `lib/extern/STM32CubeG4`.

To do this, we create our own CMakeLists.txt file in a new directory `cmake/stm32cubemx_extern/`.
This CMakeLists.txt file will replace the generated one and instead link to the shared
HAL driver library. For example, the above generated CMakeLists.txt would be replaced with the following:

```cmake
set(STM32_Drivers_Src
    ${CMAKE_CURRENT_SOURCE_DIR}/../../Core/Src/system_stm32g4xx.c
    ${CMAKE_CURRENT_SOURCE_DIR}/../../../../lib/extern/STM32CubeG4/Drivers/STM32G4xx_HAL_Driver/Src/stm32g4xx_hal_pwr_ex.c
    ${CMAKE_CURRENT_SOURCE_DIR}/../../../../lib/extern/STM32CubeG4/Drivers/STM32G4xx_HAL_Driver/Src/stm32g4xx_hal.c
    ${CMAKE_CURRENT_SOURCE_DIR}/../../../../lib/extern/STM32CubeG4/Drivers/STM32G4xx_HAL_Driver/Src/stm32g4xx_hal_rcc.c
    ${CMAKE_CURRENT_SOURCE_DIR}/../../../../lib/extern/STM32CubeG4/Drivers/STM32G4xx_HAL_Driver/Src/stm32g4xx_hal_rcc_ex.c
    ${CMAKE_CURRENT_SOURCE_DIR}/../../../../lib/extern/STM32CubeG4/Drivers/STM32G4xx_HAL_Driver/Src/stm32g4xx_hal_flash.c
    ${CMAKE_CURRENT_SOURCE_DIR}/../../../../lib/extern/STM32CubeG4/Drivers/STM32G4xx_HAL_Driver/Src/stm32g4xx_hal_flash_ex.c
    ${CMAKE_CURRENT_SOURCE_DIR}/../../../../lib/extern/STM32CubeG4/Drivers/STM32G4xx_HAL_Driver/Src/stm32g4xx_hal_flash_ramfunc.c
    ${CMAKE_CURRENT_SOURCE_DIR}/../../../../lib/extern/STM32CubeG4/Drivers/STM32G4xx_HAL_Driver/Src/stm32g4xx_hal_gpio.c
    ${CMAKE_CURRENT_SOURCE_DIR}/../../../../lib/extern/STM32CubeG4/Drivers/STM32G4xx_HAL_Driver/Src/stm32g4xx_hal_exti.c
    ${CMAKE_CURRENT_SOURCE_DIR}/../../../../lib/extern/STM32CubeG4/Drivers/STM32G4xx_HAL_Driver/Src/stm32g4xx_hal_dma.c
    ${CMAKE_CURRENT_SOURCE_DIR}/../../../../lib/extern/STM32CubeG4/Drivers/STM32G4xx_HAL_Driver/Src/stm32g4xx_hal_dma_ex.c
    ${CMAKE_CURRENT_SOURCE_DIR}/../../../../lib/extern/STM32CubeG4/Drivers/STM32G4xx_HAL_Driver/Src/stm32g4xx_hal_pwr.c
    ${CMAKE_CURRENT_SOURCE_DIR}/../../../../lib/extern/STM32CubeG4/Drivers/STM32G4xx_HAL_Driver/Src/stm32g4xx_hal_cortex.c
)
```

You can see that instead of navigating to the `Drivers/STM32G4xx_HAL_Driver/` directory
that is autogenerated for every project, we instead navigate to the shared HAL driver library
in `lib/extern/STM32CubeG4/Drivers/STM32G4xx_HAL_Driver/`.

To use this new CMakeLists.txt file instead of the autogenerated one, simply replace the
following line in the top-level CMakeLists.txt:

```cmake
add_subdirectory(cmake/stm32cubemx)
```

with

```cmake
add_subdirectory(cmake/stm32cubemx_extern)
```

Keep in mind that whenever you generate code from CubeMX which requires a new HAL driver file,
you will need to manually add that file to the `cmake/stm32cubemx_extern/CMakeLists.txt` file.
For example, if you enable the I2C peripheral in CubeMX and regenerate code, CubeMX will
generate the file `stm32g4xx_hal_i2c.c`. You will then need to add the following line to the
`cmake/stm32cubemx_extern/CMakeLists.txt` file where the other HAL driver files are listed:

```cmake
${CMAKE_CURRENT_SOURCE_DIR}/../../../../lib/extern/STM32CubeG4/Drivers/STM32G4xx_HAL_Driver/Src/stm32g4xx_hal_i2c.c
```

!!! note "TODO"
    _We should create a script to automate this process of creating and updating the `cmake/stm32cubemx_extern/CMakeLists.txt` file._

### Adding `lib/` Dependencies

To add `lib/` dependencies to a CubeMX project, add the following to `CMakeLists.txt`.

```cmake
# Add fwlib dependency
add_subdirectory(../../lib fwlib)

# Add linked libraries
target_link_libraries(${CMAKE_PROJECT_NAME}
    stm32cubemx

    # Add user defined libraries
    stm32
    units
    util
)
```

## Building and Flashing

1. `./scripts/build.sh --src <PROJECT>` will build the project
2. `./scripts/flash.sh --src <PROJECT>` will flash the project to the MCU connected to the STLINK

For example, if the project is named `myproject` and is located in `/home/user/mrover-esw/src/`,
the command to build would be:

```sh
./scripts/build.sh --src myproject
```

!!! note
    In order to use the scripts to build and flash, ensure all `*/bin` directories from CubeCLT are included in `$PATH`

